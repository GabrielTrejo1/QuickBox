{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Listado de rutas</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}" />
  <link rel="stylesheet" href="{% static 'css/pantalla_ruta.css' %}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
</head>
<body>
  {% include "includes/navbar.html" %}
  <main>
    <form action="{% url 'generar_mapa' %}" method="post" id="form-mapa">
      {% csrf_token %}
      <div class="container mt-5">
        <h2 style="text-align: center">Listado de Rutas Activas</h2>

        <!-- Tabla Rutas Activas -->
        <div class="card mb-4">
          <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
              <thead class="thead-dark">
                <tr>
                  <th>Seleccionar</th>
                  <th>Nombre Ruta</th>
                  <th>Fecha de Carga</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for ruta in rutas_activas %}
                <tr>
                  <td>
                    <input
                      type="radio"
                      class="form-check-input"
                      id="ruta-{{ ruta.id_ruta }}"
                      name="id_ruta"
                      value="{{ ruta.id_ruta }}" />
                  </td>
                  <td>{{ ruta.nombre }}</td>
                  <td>{{ ruta.fecha }}</td>
                  <td>
                    <span class="badge bg-success">Activa</span>
                  </td>
                  <td>
                    <a href="{% url 'ruta_edit' ruta.id_ruta %}" class="btn btn-warning btn-sm" style="text-decoration:none; color:black;">Editar</a>
                    <a href="{% url 'ruta_delete' ruta.id_ruta %}" class="btn btn-danger btn-sm" style="text-decoration:none; color:red;">Eliminar</a>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center">No hay rutas activas.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Selector inicio ruta y botón -->
        <div class="mb-4 d-flex gap-2 flex-wrap align-items-center">
          <input
            type="text"
            id="inicio_ruta"
            name="inicio_ruta"
            placeholder="Ubicación inicial de la ruta"
            required
            class="textbox" />
          <button type="submit" class="btn btn-primary mt-2">Generar Mapa</button>
        </div>

        <!-- Tabla Rutas Finalizadas -->
        <div class="card">

        <h2 style="text-align: center">Listado de Rutas Finalizadas-Canceladas</h2>
          <div class="card-body p-0">
            <table class="table table-striped table-hover mb-0">
              <thead class="thead-dark">
                <tr>
                  <th>Nombre Ruta</th>
                  <th>Fecha de Carga</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for ruta in rutas_finalizadas %}
                <tr>
                  <td>{{ ruta.nombre }}</td>
                  <td>{{ ruta.fecha }}</td>
                  <td>
                    {% if ruta.estado == "Terminada" %}
                      <span class="badge bg-primary" style="color:Green"><b>Terminada</b></span>
                    {% elif ruta.estado == "Cancelada" %}
                      <span class="badge bg-danger" style="color:red"><b>Cancelada</b></span>
                    {% else %}
                      <span class="badge bg-secondary">{{ ruta.estado|title }}</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if ruta.estado == "Terminada" %}
                    <a href="{% url 'ruta_detalle' id_ruta=ruta.id_ruta %}" class="btn btn-info btn-sm" style="text-decoration:none; color:blue;"> <i class="bi bi-eye"></i> Ver</a>
                    {% elif ruta.estado == "Cancelada" %}
                    <a href="{% url 'ruta_cancelada' pk=ruta.id_ruta %}" class="btn btn-info btn-sm" style="text-decoration:none; color:blue;"> <i class="bi bi-eye"></i> Ver</a>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center">No hay rutas finalizadas.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </form>

    {% if mapa_url %}
    <div class="container mt-5">
      <h3>Ruta Original (sin optimizar)</h3>
      <ul>
        <li><strong>Distancia total:</strong> {{ distancia_original }} km</li>
        <li><strong>Duración estimada:</strong> {{ duracion_original }} minutos</li>
        <li><strong>Direcciones:</strong></li>
        <ol>
          {% for direccion in ruta_original %}
          <li>{{ direccion }}</li>
          {% endfor %}
        </ol>
      </ul>

      <hr />

      <h3>Ruta Optimizada</h3>
      <ul>
        <li><strong>Distancia total:</strong> {{ distancia_km }} km</li>
        <li><strong>Duración estimada:</strong> {{ duracion_min }} minutos</li>
        <li><strong>Direcciones en orden optimizado:</strong></li>
        <ol>
          {% for direccion in ruta_optima %}
          <li>{{ direccion }}</li>
          {% endfor %}
        </ol>
      </ul>

      <hr />

      <h4>Mejoras respecto a la ruta original</h4>
      <ul>
        <li><strong>Reducción de distancia:</strong> {{ mejora_distancia }}%</li>
        <li><strong>Reducción de duración:</strong> {{ mejora_duracion }}%</li>
      </ul>

      <div class="embed-responsive embed-responsive-16by9 mt-4">
        <iframe
          class="embed-responsive-item"
          width="100%"
          height="450"
          frameborder="0"
          style="border: 0"
          allowfullscreen
          src="{{ mapa_url }}"></iframe>
      </div>
    </div>
    {% endif %}
  </main>

  <script>
    function initAutocomplete() {
      const input = document.getElementById("inicio_ruta");
      const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ["geocode"],
        componentRestrictions: { country: "ar" },
      });

      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          alert("Por favor, selecciona una ubicación válida del listado.");
          input.value = "";
        }
      });
    }

    document.getElementById("form-mapa").addEventListener("submit", function (event) {
      const inicioRuta = document.getElementById("inicio_ruta").value.trim();
      const rutaSeleccionada = document.querySelector('input[name="id_ruta"]:checked');

      if (!rutaSeleccionada) {
        alert("Por favor, selecciona una ruta.");
        event.preventDefault();
        return false;
      }

      if (!inicioRuta) {
        alert("Por favor, ingresa la ubicación de partida.");
        event.preventDefault();
        return false;
      }
    });
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3P7JedZwrkvQUVjTXgdBEm7Nx4YwpFvE&libraries=places&language=es&callback=initAutocomplete"
    async defer></script>
</body>
</html>
